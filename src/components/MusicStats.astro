---
import musicData from '../data/music.json';
interface Item {
  name: string;
  url: string;
  image?: string;
  artist?: string;
  plays?: string | number;
}

interface DayStat {
  dayName: string;
  date: string;
  hours: string;
  lastHours: string;
  topArtist: string | null;
}

const data = musicData || {};
const history = (data.history || []) as DayStat[];
const week = data.week || { artists: [], albums: [], tracks: [] };
const month = data.month || { artists: [], albums: [], tracks: [] };
const weekAlbums = Array.isArray(week.albums) ? week.albums : [];
const weekArtists = Array.isArray(week.artists) ? week.artists : [];
const monthAlbums = Array.isArray(month.albums) ? month.albums : [];
const monthArtists = Array.isArray(month.artists) ? month.artists : [];

// Calculate totals for header
const totalThisWeek = history.reduce((acc, d) => acc + parseFloat(d.hours), 0).toFixed(1);
const totalLastWeek = history.reduce((acc, d) => acc + parseFloat(d.lastHours), 0).toFixed(1);
const trend = (parseFloat(totalThisWeek) - parseFloat(totalLastWeek)).toFixed(1);
const isPositive = parseFloat(trend) > 0;

// Calculate max value for bar scaling
const maxVal = Math.max(
  ...history.map((d) => Math.max(parseFloat(d.hours), parseFloat(d.lastHours))),
  0.1 // prevent divide by zero
);

function getDayName(dateStr: string) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' });
}
---

<div class="space-y-12">
  <div class="space-y-6">
    <div class="flex items-end justify-between">
      <div class="space-y-1">
        <h3 class="text-lg font-semibold text-black dark:text-white">Recent Music</h3>
        <div class="flex items-baseline gap-3 text-xs">
          <span class="font-bold text-black dark:text-white">{totalThisWeek}h</span>
          <span class="text-neutral-400">past 7 days</span>
          <span
            class={`font-medium ${isPositive ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}`}
          >
            {isPositive ? '+' : ''}{trend}h vs prev week
          </span>
        </div>
      </div>
      <a
        href="/music/"
        class="group block font-mono text-[9px] tracking-[0.1em] text-neutral-400 uppercase transition-colors hover:text-black dark:hover:text-white"
      >
        Full music stats <span class="inline-block transition-transform group-hover:translate-x-0.5"
          >â†’</span
        >
      </a>
    </div>

    <!-- Daily Log Visualization -->
    <div class="space-y-2 border-t border-black/10 pt-4 dark:border-white/10">
      {
        history.map((d) => {
          const h = parseFloat(d.hours);
          const lh = parseFloat(d.lastHours);
          const w = (h / maxVal) * 100;
          const lw = (lh / maxVal) * 100;
          const diff = h - lh;
          const diffStr = (diff > 0 ? '+' : '') + diff.toFixed(1) + 'h';

          return (
            <div class="group relative text-xs">
              
              <!-- Mobile Layout -->
              <div class="grid grid-cols-[2rem_1fr] items-center gap-3 md:hidden">
                <div class="font-mono text-[10px] text-neutral-400 uppercase tracking-wider">{getDayName(d.date)}</div>
                
                <div class="relative flex h-6 items-center min-w-0">
                  <!-- Bar -->
                  <div class="group/chart relative h-full w-[100px] shrink-0">
                    <div class="absolute top-1 bottom-1 rounded-sm bg-neutral-300 transition-all dark:bg-neutral-700" style={`width: ${lw}%`}></div>
                    <div class="absolute top-2.5 bottom-2.5 rounded-full bg-black shadow-sm transition-all dark:bg-white" style={`width: ${w}%`}></div>
                  </div>

                  <!-- Hours -->
                  <div class="ml-3 font-mono text-[10px] text-neutral-500 whitespace-nowrap">
                    {d.hours}h <span class="text-neutral-400">{diffStr}</span>
                  </div>

                  <!-- Artist -->
                  {d.topArtist && (
                    <div class="ml-3 min-w-0 flex-1 truncate font-medium text-neutral-600 dark:text-neutral-400 text-[10px]">
                      <span class="mr-1 text-[9px] uppercase tracking-wider text-neutral-400">Top Artist:</span>
                      <a 
                        href={`https://www.last.fm/music/${encodeURIComponent(d.topArtist)}`}
                        target="_blank"
                        class="hover:text-black hover:underline dark:hover:text-white transition-colors"
                      >
                        {d.topArtist}
                      </a>
                    </div>
                  )}
                </div>
              </div>

              <!-- Desktop Layout -->
              <div class="hidden md:flex items-center">
                <!-- Left Half -->
                <div class="w-1/2 pr-8 flex items-center gap-3">
                   <div class="font-mono text-[10px] text-neutral-400 uppercase tracking-wider w-8 shrink-0">{getDayName(d.date)}</div>
                   <div class="group/chart relative h-6 w-full max-w-[160px]">
                      <div class="absolute top-1 bottom-1 rounded-sm bg-neutral-300 transition-all dark:bg-neutral-700" style={`width: ${lw}%`}></div>
                      <div class="absolute top-2.5 bottom-2.5 rounded-full bg-black shadow-sm transition-all dark:bg-white" style={`width: ${w}%`}></div>
                   </div>
                   <div class="font-mono text-[10px] text-neutral-500 whitespace-nowrap">
                     {d.hours}h <span class="text-neutral-400">{diffStr}</span>
                   </div>
                </div>

                <!-- Right Half -->
                <div class="w-1/2 pl-8 flex items-center">
                   {d.topArtist && (
                    <div class="min-w-0 flex-1 truncate font-medium text-neutral-600 dark:text-neutral-400 text-[10px] sm:text-xs">
                      <span class="mr-1 text-[9px] uppercase tracking-wider text-neutral-400">Top Artist:</span>
                      <a 
                        href={`https://www.last.fm/music/${encodeURIComponent(d.topArtist)}`}
                        target="_blank"
                        class="hover:text-black hover:underline dark:hover:text-white transition-colors"
                      >
                        {d.topArtist}
                      </a>
                    </div>
                   )}
                </div>
              </div>

            </div>
          );
        })
      }
    </div>
  </div>

  <div class="grid gap-8 divide-black/10 md:grid-cols-2 md:gap-0 md:divide-x dark:divide-white/10">
    <div class="space-y-8 md:pr-8">
      <h4 class="text-[10px] font-bold tracking-wider text-neutral-400 uppercase">Last 7 Days</h4>
      <div class="space-y-6">
        <div class="space-y-3">
          <h5 class="text-[10px] font-bold tracking-wider text-neutral-400 uppercase">
            Top Albums
          </h5>
          <ul class="space-y-2">
            {
              weekAlbums.slice(0, 3).map((alb: Item, i: number) => (
                <li class="group flex items-center gap-3">
                  <span class="w-3 font-mono text-xs text-neutral-400">{i + 1}</span>
                  {alb.image ? (
                    <img
                      src={alb.image}
                      alt={alb.name}
                      class="h-8 w-8 rounded border border-black/10 object-cover dark:border-white/10"
                    />
                  ) : (
                    <div class="flex h-8 w-8 items-center justify-center rounded border border-black/10 bg-neutral-100 text-[10px] text-neutral-500 dark:border-white/10 dark:bg-neutral-800">
                      CD
                    </div>
                  )}
                  <div class="min-w-0 flex-1 overflow-hidden">
                    <>
                      <a
                        href={alb.url}
                        target="_blank"
                        class="block truncate text-sm text-neutral-700 decoration-1 underline-offset-2 transition-colors group-hover:text-black group-hover:underline dark:text-neutral-300 dark:group-hover:text-white"
                      >
                        {alb.name}
                      </a>
                      <div class="truncate text-xs text-neutral-500">{alb.artist}</div>
                    </>
                  </div>
                  <span class="font-mono text-xs text-neutral-400">{alb.plays}</span>
                </li>
              ))
            }
          </ul>
        </div>
        <div class="space-y-3 border-t border-black/10 pt-4 dark:border-white/10">
          <h5 class="text-[10px] font-bold tracking-wider text-neutral-400 uppercase">
            Top Artists
          </h5>
          <ul class="space-y-1">
            {
              weekArtists.slice(0, 5).map((art: Item, i: number) => (
                <li class="group flex items-center justify-between">
                  <div class="flex min-w-0 items-center gap-2">
                    <span class="w-3 shrink-0 font-mono text-[10px] text-neutral-400">{i + 1}</span>
                    <a
                      href={art.url}
                      target="_blank"
                      class="truncate text-sm text-neutral-600 transition-colors group-hover:text-black dark:text-neutral-400 dark:group-hover:text-white"
                    >
                      {art.name}
                    </a>
                  </div>
                  <span class="ml-2 font-mono text-xs text-neutral-400">{art.plays}</span>
                </li>
              ))
            }
          </ul>
        </div>
      </div>
    </div>
    <div class="space-y-8 md:pl-8">
      <h4 class="text-[10px] font-bold tracking-wider text-neutral-400 uppercase">Last 3 Months</h4>
      <div class="space-y-6">
        <div class="space-y-3">
          <h5 class="text-[10px] font-bold tracking-wider text-neutral-400 uppercase">
            Top Albums
          </h5>
          <ul class="space-y-2">
            {
              monthAlbums.slice(0, 3).map((alb: Item, i: number) => (
                <li class="group flex items-center gap-3">
                  <span class="w-3 font-mono text-xs text-neutral-400">{i + 1}</span>
                  {alb.image ? (
                    <img
                      src={alb.image}
                      alt={alb.name}
                      class="h-8 w-8 rounded border border-black/10 object-cover dark:border-white/10"
                    />
                  ) : (
                    <div class="flex h-8 w-8 items-center justify-center rounded border border-black/10 bg-neutral-100 text-[10px] text-neutral-500 dark:border-white/10 dark:bg-neutral-800">
                      CD
                    </div>
                  )}
                  <div class="min-w-0 flex-1 overflow-hidden">
                    <>
                      <a
                        href={alb.url}
                        target="_blank"
                        class="block truncate text-sm text-neutral-700 decoration-1 underline-offset-2 transition-colors group-hover:text-black group-hover:underline dark:text-neutral-300 dark:group-hover:text-white"
                      >
                        {alb.name}
                      </a>
                      <div class="truncate text-xs text-neutral-500">{alb.artist}</div>
                    </>
                  </div>
                  <span class="font-mono text-xs text-neutral-400">{alb.plays}</span>
                </li>
              ))
            }
          </ul>
        </div>
        <div class="space-y-3 border-t border-black/10 pt-4 dark:border-white/10">
          <h5 class="text-[10px] font-bold tracking-wider text-neutral-400 uppercase">
            Top Artists
          </h5>
          <ul class="space-y-1">
            {
              monthArtists.slice(0, 5).map((art: Item, i: number) => (
                <li class="group flex items-center justify-between">
                  <div class="flex min-w-0 items-center gap-2">
                    <span class="w-3 shrink-0 font-mono text-[10px] text-neutral-400">{i + 1}</span>
                    <a
                      href={art.url}
                      target="_blank"
                      class="truncate text-sm text-neutral-600 transition-colors group-hover:text-black dark:text-neutral-400 dark:group-hover:text-white"
                    >
                      {art.name}
                    </a>
                  </div>
                  <span class="ml-2 font-mono text-xs text-neutral-400">{art.plays}</span>
                </li>
              ))
            }
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
