---
import Link from "@components/Link.astro";
import { getPostHref } from "@lib/blog";

const { post } = Astro.props;

// Import all images in the blog content directory to resolve relative paths
const images = import.meta.glob('/src/content/blog/**/*.{jpeg,jpg,png,gif,svg}');

async function getPostImage(post) {
  const { data, body, id } = post;

  // 1. Check frontmatter
  const fmImage = data.coverImage || data.coverPhoto || data.heroImage;
  if (fmImage) {
    return fmImage.src || fmImage;
  }

  // 2. Find image marked with id="listing-image" in Markdown body
  // Matches: <div ... id="listing-image" ...> ... ![alt](path) ...
  const listingImageRegex = /<div[^>]*?id=["']listing-image["'][^>]*?>[\s\S]*?(?:!\[.*?\]\((.*?)\)|<img[^>]+src=["'](.*?)["'])/;
  const match = body.match(listingImageRegex);
  
  let imagePath = match ? (match[1] || match[2]) : null;

  // 3. Fallback to first image in post if needed
  if (!imagePath) {
    const firstImageRegex = /(?:!\[.*?\]\((.*?)\)|<img[^>]+src=["'](.*?)["'])/;
    const firstMatch = body.match(firstImageRegex);
    if (firstMatch) {
      imagePath = firstMatch[1] || firstMatch[2];
    }
  }

  if (!imagePath) return undefined;

  // 4. Resolve path to full URL
  if (imagePath.startsWith('http') || imagePath.startsWith('/')) {
    return imagePath;
  }

  // Resolve relative path (e.g. "./astro.png") relative to post file
  const cleanPath = imagePath.replace(/^\.\//, '');
  const postDir = id.substring(0, id.lastIndexOf('/'));
  const fullPath = `/src/content/blog/${postDir ? postDir + '/' : ''}${cleanPath}`;

  // 5. Load image via glob
  const imageLoader = images[fullPath];
  if (imageLoader) {
    const mod = await imageLoader();
    return mod.default.src;
  }

  return undefined;
}

const coverImage = await getPostImage(post);
---

<li>
  <Link href={getPostHref(post)} class="group block no-underline">
    <div class="flex justify-between items-center gap-4">
      <div class="flex flex-col gap-1">
        <span class="font-medium text-black dark:text-white group-hover:underline decoration-1 underline-offset-2 leading-tight">
          {post.data.title}
        </span>
        <p class="text-xs text-neutral-500">
          {post.data.date.getUTCFullYear()}-{String(post.data.date.getUTCMonth() + 1).padStart(2, '0')}-{String(post.data.date.getUTCDate()).padStart(2, '0')}
        </p>
      </div>
      {coverImage && (
        <div class="shrink-0 w-24 h-24 overflow-hidden rounded-md bg-neutral-100 dark:bg-neutral-800">
          <img
            src={coverImage}
            alt={post.data.title}
            class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
          />
        </div>
      )}
    </div>
  </Link>
</li>
