---
const { items } = Astro.props;

// Determine the window: Last 30 days
const now = new Date();
const thirtyDaysAgo = new Date(now);
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
thirtyDaysAgo.setHours(0, 0, 0, 0);

// Filter items to last 30 days
const recentItems = items.filter((item) => item.data.date >= thirtyDaysAgo);

// Bin data by day for the sparkline
const dayCounts = new Array(30).fill(0);
recentItems.forEach((item) => {
  const dayDiff = Math.floor(
    (item.data.date.getTime() - thirtyDaysAgo.getTime()) / (1000 * 60 * 60 * 24)
  );
  if (dayDiff >= 0 && dayDiff < 30) {
    dayCounts[dayDiff]++;
  }
});

const maxCount = Math.max(...dayCounts, 1);

const formatDate = (date) => {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};

const rangeLabel = `${formatDate(thirtyDaysAgo)} - ${formatDate(now)}`;
---

<section class="animate space-y-4">
  <div
    class="flex items-baseline justify-between border-b border-black/10 pb-4 dark:border-white/10"
  >
    <h3 class="text-lg font-semibold text-black dark:text-white">Recent Activity</h3>
    <span class="font-mono text-[9px] tracking-[0.1em] text-neutral-400 uppercase"
      >{rangeLabel}</span
    >
  </div>

  <div class="space-y-4">
    <!-- Sparkline Visualization -->
    <div class="h-8 w-full" aria-hidden="true">
      <svg viewBox="0 0 30 10" preserveAspectRatio="none" class="h-full w-full">
        {
          dayCounts.map((count, index) => {
            // Scale height: if count > 0, scale between 20% and 100% of height. If 0, show tiny blip.
            const height = count > 0 ? (count / maxCount) * 8 + 2 : 0.5;
            const y = 10 - height;
            return (
              <rect
                x={index}
                y={y}
                width="0.6"
                height={height}
                class={
                  count > 0
                    ? 'fill-black dark:fill-white'
                    : 'fill-neutral-200 dark:fill-neutral-800'
                }
                rx="0.2"
              />
            );
          })
        }
      </svg>
    </div>

    <!-- Horizontal Scroll List -->
    <div class="-mx-1 flex overflow-x-auto px-1 pb-2">
      {
        recentItems.map((item) => (
          <a
            href={item.type === 'blog' ? `/blog/${item.slug}/` : `/${item.type}/${item.slug}/`}
            class="group w-48 flex-none pr-6"
          >
            <div class="flex flex-col gap-1">
              <span class="font-mono text-[10px] tracking-wider text-neutral-500 uppercase">
                {formatDate(item.data.date)} â€¢ {item.type}
              </span>
              <h4 class="line-clamp-2 text-sm leading-snug font-medium text-black decoration-1 underline-offset-2 group-hover:underline dark:text-white">
                {item.data.title}
              </h4>
            </div>
          </a>
        ))
      }
    </div>
  </div>
</section>
