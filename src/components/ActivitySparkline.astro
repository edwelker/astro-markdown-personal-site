---
const { items } = Astro.props;

// Determine the window: Last 30 days, or fallback to last 5 items
const now = new Date();
const thirtyDaysAgo = new Date(now);
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

let recentItems = items.filter(item => item.data.date >= thirtyDaysAgo);

if (recentItems.length < 5) {
    recentItems = items.slice(0, 5);
}

// Calculate date range for the sparkline
const dates = recentItems.map(i => i.data.date.getTime());
const maxDate = dates.length > 0 ? Math.max(...dates) : now.getTime();
const minDate = dates.length > 0 ? Math.min(...dates) : thirtyDaysAgo.getTime();
const timeSpan = maxDate - minDate;

const getPosition = (date) => {
    if (timeSpan === 0) return 100;
    return ((date.getTime() - minDate) / timeSpan) * 100;
};

const formatDate = (date) => {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};

const rangeLabel = timeSpan === 0 
    ? formatDate(new Date(maxDate)) 
    : `${formatDate(new Date(minDate))} - ${formatDate(new Date(maxDate))}`;
---

<div class="space-y-3">
  <div class="flex justify-between items-end">
    <h2 class="font-bold text-xl">Recent Activity</h2>
    <span class="text-xs text-gray-500 font-mono">{rangeLabel}</span>
  </div>

  <!-- Sparkline Visualization -->
  <div class="relative h-6 w-full mt-2 select-none" aria-hidden="true">
    <!-- Timeline base -->
    <div class="absolute top-1/2 left-0 right-0 h-px bg-gray-200 dark:bg-gray-700 -translate-y-1/2"></div>
    
    {recentItems.map((item) => (
      <div 
        class={`absolute top-1/2 w-2 h-2 rounded-full -translate-y-1/2 -translate-x-1/2 border border-white dark:border-gray-900 ${
            item.type === 'blog' ? 'bg-black dark:bg-white z-10' : 
            item.type === 'photos' ? 'bg-blue-500 z-10' :
            'bg-gray-400 dark:bg-gray-500 z-0'
        }`}
        style={`left: ${getPosition(item.data.date)}%;`}
        title={`${item.data.title} (${formatDate(item.data.date)})`}
      ></div>
    ))}
  </div>

  <!-- Horizontal Scroll List -->
  <div class="flex overflow-x-auto gap-3 pb-2 -mx-1 px-1">
    {recentItems.map((item) => (
      <a 
        href={item.type === 'blog' ? `/blog/${item.slug}/` : `/${item.type}/${item.slug}/`} 
        class="flex-none w-60 p-2 border border-gray-200 dark:border-gray-800 rounded-lg hover:border-gray-400 dark:hover:border-gray-600 transition-colors bg-white dark:bg-gray-900"
      >
        <div class="flex flex-col h-full justify-center gap-1">
          <span class={`text-[10px] font-bold uppercase tracking-wider ${
              item.type === 'blog' ? 'text-black dark:text-white' : 
              item.type === 'photos' ? 'text-blue-600 dark:text-blue-400' :
              'text-gray-500'
          }`}>
            {item.type}
          </span>
          <h3 class="font-medium text-sm leading-tight line-clamp-2">{item.data.title}</h3>
        </div>
      </a>
    ))}
  </div>
</div>
