---
import Layout from "@layouts/Layout.astro";
import gasData from "@data/gas.json";
import { sortByNetPrice } from "../../lib/gas-sort";
import { normalizeGasData } from "../../lib/gas-data-normalization";

export function getStaticPaths() {
  return [
    { params: { region: "md" }, props: { name: "Maryland", data: gasData.md } },
    { params: { region: "ny" }, props: { name: "New York", data: gasData.ny } },
    { params: { region: "ma" }, props: { name: "Massachusetts", data: gasData.ma } },
  ];
}

const { region } = Astro.params;
const { name, data: rawData } = Astro.props;

const title = `Gas Prices - ${name}`;
const description = `Latest gas prices for ${name}.`;

function formatPrice(price: string | number) {
  if (price === undefined || price === null || price === '') return '';
  const num = parseFloat(String(price).replace(/[^0-9.-]+/g, ""));
  return isNaN(num) ? String(price) : num.toFixed(2);
}

const data = normalizeGasData(rawData, region).sort(sortByNetPrice);
---

<Layout title={title} description={description}>
  <div class="w-full px-2 sm:px-4 py-8">
    <div class="animate">
      <div class="mb-6 max-w-screen-md mx-auto">
        <a href="/gas/" class="text-sm text-neutral-500 hover:text-black dark:hover:text-white transition-colors">← Back to Gas</a>
        <h1 class="font-semibold text-2xl mt-2">{name} Gas Prices</h1>
      </div>

      <div class="mb-4 max-w-screen-md mx-auto flex flex-col sm:flex-row gap-3">
        <input
          type="text"
          id="gas-filter"
          placeholder="Filter by City or Zip..."
          class="flex-grow px-4 py-2 border border-neutral-200 dark:border-neutral-700 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-neutral-500"
        />
        <button
          id="sort-distance"
          class="px-4 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 rounded-lg text-sm font-medium transition-colors whitespace-nowrap"
        >
          Calculate Driving Times
        </button>
      </div>

      <div id="distance-status" style="display: none;" class="mb-4 max-w-screen-md mx-auto text-xs text-neutral-500 italic text-center">
        Calculating driving times...
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-xs sm:text-sm text-left">
          <thead class="text-neutral-500 uppercase bg-neutral-50 dark:bg-neutral-800 dark:text-neutral-400">
            <tr>
              <th class="w-full px-2 py-3 cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="Station" data-label="Station / Location">Station / Location ↕</th>
              <th class="px-2 py-3 text-right whitespace-nowrap cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="Base" data-label="Price">Price ↕</th>
              <th class="hidden sm:table-cell px-2 py-3 text-right whitespace-nowrap select-none">Discount</th>
              <th class="px-2 py-3 text-right whitespace-nowrap cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="Net" data-label="Net">Net ↑</th>
              <th class="px-2 py-3 text-right whitespace-nowrap cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="Time" data-label="Time">Time ↕</th>
            </tr>
          </thead>
          <tbody id="gas-table-body">
            {data.map((row) => {
              const streetRaw = (row.Address || "").split(',')[0].replace(/^\d+\S*\s+/, "");
              const street = streetRaw.toLowerCase().split(/\s+/).map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
              const city = (row.City || '').split('/')[0].trim();
              const displayLocation = `${street}, ${city}`;
              const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${row.Address}, ${row.City} ${row.Zip}`)}`;

              return (
                <tr
                  class="border-b border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-800/50"
                  data-lat={row.lat}
                  data-lng={row.lng}
                >
                  <td class="px-2 py-3 font-medium">
                    <a href={mapsUrl} target="_blank" rel="noopener noreferrer" class="hover:underline block">
                      <strong>{row.Station || ''}</strong>: <span class="text-[10px] sm:text-xs text-neutral-600 dark:text-neutral-400">{displayLocation}</span>
                    </a>
                  </td>
                  <td class="px-2 py-3 text-right whitespace-nowrap">{formatPrice(row.Base)}</td>
                  <td class="hidden sm:table-cell px-2 py-3 text-right whitespace-nowrap">{row.Discount}</td>
                  <td class="px-2 py-3 text-right whitespace-nowrap font-bold">{formatPrice(row.Net)}</td>
                  <td class="px-2 py-3 text-right whitespace-nowrap text-neutral-400 italic">—</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      <p class="text-xs text-neutral-400 mt-4 text-center">
        Data sourced from <a href="https://github.com/edwelker/find_cheap_local_gas" class="underline">edwelker/find_cheap_local_gas</a>.
      </p>
    </div>
  </div>
</Layout>

<script id="gas-data" type="application/json" set:html={JSON.stringify(data)}></script>

<script>
  import { filterGasData } from '../../lib/gas-filter';
  import { calculateDistances } from '../../lib/gas-distance';
  import { sortGasData } from '../../lib/gas-sort';

  function initGasPage() {
    const tableBody = document.getElementById('gas-table-body');
    // Exit if the main table element isn't on the page. This makes the script
    // more robust in case it's loaded on a page without the gas table.
    if (!tableBody) {
      return;
    }

    const initialData = JSON.parse(document.getElementById('gas-data').textContent);
    console.log("Gas script initialized. Total rows:", initialData.length);

    let sortCol = 'Net';
    let sortAsc = true;
    let filterQuery = "";
    let userCoords = null;
    let distances = {}; // Keyed by Address: { duration: seconds, distance: miles }

    const filterInput = document.getElementById('gas-filter');
    const distanceBtn = document.getElementById('sort-distance');
    const distanceStatus = document.getElementById('distance-status');
    const headers = document.querySelectorAll('th[data-sort]');

    function formatPrice(val) {
      if (val === undefined || val === null || val === '') return '';
      const num = parseFloat(String(val).replace(/[^0-9.-]+/g, ""));
      return isNaN(num) ? String(val) : num.toFixed(2);
    }


    async function calculateAllDistances() {
      console.log("UI: calculateAllDistances triggered");
      
      const uiCallbacks = {
        setStatus: (text, show) => {
          distanceStatus.style.display = show ? 'block' : 'none';
          if (text) distanceStatus.textContent = text;
        },
        setButtonState: (text, disabled) => {
          distanceBtn.textContent = text;
          distanceBtn.disabled = disabled;
        },
        alert: (message) => alert(message),
        updateTable: updateTable
      };

      const result = await calculateDistances({
        initialData,
        distances,
        userCoords,
        uiCallbacks
      });

      if (result) {
        distances = result.newDistances;
        userCoords = result.newUserCoords;
        // Final table update to ensure it reflects the final state after all batches.
        updateTable(); 
      }
    }

    function renderTable(data) {
      tableBody.innerHTML = data.map(row => {
        const d = distances[row.Address];
        const displayStr = d ? `${Math.round(d.duration / 60)}m (${d.distance.toFixed(1)}mi)` : '—';

        const streetRaw = (row.Address || "").split(',')[0].replace(/^\d+\S*\s+/, "");
        const street = streetRaw.toLowerCase().split(/\s+/).map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        const city = (row.City || '').split('/')[0].trim();
        const displayLocation = `<strong>${row.Station || ''}</strong>: <span class="text-[10px] sm:text-xs text-neutral-600 dark:text-neutral-400">${street}, ${city}</span>`;
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${row.Address}, ${row.City} ${row.Zip}`)}`;

        return `
        <tr
          class="border-b border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-800/50"
          data-lat="${row.lat || ''}"
          data-lng="${row.lng || ''}"
        >
          <td class="px-2 py-3 font-medium">
            <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline block">
              ${displayLocation}
            </a>
          </td>
          <td class="px-2 py-3 text-right whitespace-nowrap">${formatPrice(row.Base)}</td>
          <td class="hidden sm:table-cell px-2 py-3 text-right whitespace-nowrap">${row.Discount || ''}</td>
          <td class="px-2 py-3 text-right whitespace-nowrap font-bold">${formatPrice(row.Net)}</td>
          <td class="px-2 py-3 text-right whitespace-nowrap ${d ? '' : 'text-neutral-400 italic'}">${displayStr}</td>
        </tr>
      `}).join('');
    }

    function updateTable() {
      // Filter
      let filtered = filterGasData(initialData, filterQuery);

      // Sort
      if (sortCol) {
        sortGasData(filtered, { sortCol, sortAsc, distances });
      }

      // Update Headers
      headers.forEach(th => {
        const col = th.getAttribute('data-sort');
        const label = th.getAttribute('data-label');
        let arrow = ' ↕';
        if (col === sortCol) {
          arrow = sortAsc ? ' ↑' : ' ↓';
        }
        th.textContent = label + arrow;
      });

      renderTable(filtered);
    }

    headers.forEach(th => {
      th.addEventListener('click', () => {
        const column = th.getAttribute('data-sort');
        console.log("Header clicked:", column);
        if (column === 'Time' && !userCoords) {
          calculateAllDistances();
          return;
        }
        if (sortCol === column) {
          sortAsc = !sortAsc;
        } else {
          sortCol = column;
          sortAsc = true;
        }
        updateTable();
      });
    });

    filterInput.addEventListener('input', (e) => {
      filterQuery = e.target.value.toLowerCase();
      updateTable();
    });

    distanceBtn.addEventListener('click', () => {
      console.log("Button clicked");
      calculateAllDistances();
    });
  }

  document.addEventListener('astro:page-load', initGasPage);
</script>
