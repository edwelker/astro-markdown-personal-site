---
export const prerender = false;

import { getMyTeamsNews, getAllLeagueNews, MY_TEAMS } from '../lib/sports';
import Layout from '../layouts/Layout.astro';

// Cache the response for 15 minutes (900 seconds) at the edge (Cloudflare) and in the browser.
// This prevents the Worker from running on every request, significantly reducing usage if scraped.
Astro.response.headers.set('Cache-Control', 'public, max-age=900, s-maxage=900');

// Initialize data containers
let myTeamsNews = [];
let allLeagueNews = [];
let fetchError = null;

// Helper to timeout fetches so the worker doesn't hang indefinitely
const fetchWithTimeout = (promise, ms = 8000) => {
    const timeout = new Promise((_, reject) =>
        setTimeout(() => reject(new Error(`Request timed out after ${ms}ms`)), ms)
    );
    return Promise.race([promise, timeout]);
};

try {
    console.log('[Sports] Starting data fetch...');
    const startTime = Date.now();

    // Wrap the entire fetch operation
    const results = await fetchWithTimeout(
        Promise.all([
            getMyTeamsNews().catch(err => {
                console.error('[Sports] Error fetching team news:', err);
                return [];
            }),
            getAllLeagueNews().catch(err => {
                console.error('[Sports] Error fetching league news:', err);
                return [];
            })
        ]),
        9000 // 9 second timeout (Cloudflare workers have limits)
    );

    [myTeamsNews, allLeagueNews] = results;

    console.log(`[Sports] Data fetch completed in ${Date.now() - startTime}ms`);
    console.log(`[Sports] Items fetched: Teams=${myTeamsNews?.length}, League=${allLeagueNews?.length}`);

} catch (error) {
    console.error('[Sports] Critical error during data fetch:', error);
    fetchError = error;
    // Fallback to empty arrays
    myTeamsNews = [];
    allLeagueNews = [];
}

const TEAM_COUNTS = {
    'Red Sox': 10,
    'Knicks': 5,
    'Celtics': 5
};
const DEFAULT_COUNT = 4;

let teamData = [];

try {
    if (!MY_TEAMS || !Array.isArray(MY_TEAMS)) {
        throw new Error('MY_TEAMS configuration is missing or invalid');
    }

    // Group and filter news by team
    teamData = MY_TEAMS.map(team => {
        const allItems = Array.isArray(myTeamsNews) ? myTeamsNews.filter(i => i.source === team.name) : [];

        // Sort by date descending
        allItems.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

        const limit = TEAM_COUNTS[team.name] || DEFAULT_COUNT;

        // Ensure item.date is a Date object before comparison and is valid
        const items = allItems.filter(item => {
            if (!item || !item.date) return false;
            const d = new Date(item.date);
            return !isNaN(d.getTime());
        }).slice(0, limit);

        return {
            ...team,
            items
        };
    }).filter(t => t.items.length > 0);
} catch (e) {
    console.error('[Sports] Error processing team data:', e);
    // teamData remains []
}

const now = new Date();
const lastUpdated = now.toLocaleString('en-US', {
    timeZone: 'America/New_York',
    dateStyle: 'medium',
    timeStyle: 'short'
});

const tabs = [
    { id: 'my-teams', label: 'My Teams' },
    { id: 'all', label: 'All News' },
    { id: 'mlb', label: 'MLB' },
    { id: 'nba', label: 'NBA' }
];

function formatRelativeTime(dateInput) {
    if (!dateInput) return '';
    const date = new Date(dateInput);
    // Safety check for invalid dates
    if (isNaN(date.getTime())) return '';

    const now = new Date();
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
    const diffInDays = Math.floor(diffInSeconds / 86400);

    if (diffInDays === 0) {
        return 'Today';
    } else if (diffInDays === 1) {
        return 'Yesterday';
    } else {
        return `${diffInDays} days ago`;
    }
}

function decodeHtmlEntities(str) {
    if (!str) return "";
    return str.replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(dec))
              .replace(/&#x([0-9a-fA-F]+);/g, (match, hex) => String.fromCharCode(parseInt(hex, 16)))
              .replace(/&quot;/g, '"')
              .replace(/&apos;/g, "'")
              .replace(/&amp;/g, '&')
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>');
}

function getSourceDomain(url) {
    try {
        const domain = new URL(url).hostname;
        return domain.replace('www.', '');
    } catch (e) {
        return '';
    }
}
---

<Layout title="Sports Feed">
  <div class="max-w-2xl mx-auto px-4 py-8">
    <div class="flex justify-between items-end mb-8">
        <div>
            <h1 class="text-3xl font-bold text-black dark:text-white">Sports Feed</h1>
            <div class="text-xs text-neutral-400 mt-1 space-x-2">
                <span>Sources:</span>
                <a href="https://www.mlbtraderumors.com" target="_blank" rel="noopener noreferrer" class="hover:text-blue-500 transition-colors">MLB Trade Rumors</a>
                <a href="https://www.hoopsrumors.com" target="_blank" rel="noopener noreferrer" class="hover:text-blue-500 transition-colors">Hoops Rumors</a>
            </div>
        </div>
        <span id="last-updated" data-timestamp={now.toISOString()} class="text-xs text-neutral-500 font-mono mb-1">Updated: {lastUpdated}</span>
    </div>

    {fetchError && (
        <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm text-red-600 dark:text-red-400">
            <p class="font-bold">Unable to load some sports data.</p>
            <p>Please try refreshing the page in a few moments.</p>
        </div>
    )}

    <div class="space-y-6">
        <!-- Tabs Navigation -->
        <div class="flex gap-6 border-b border-neutral-200 dark:border-neutral-800 pb-1 overflow-x-auto">
            {tabs.map(tab => (
                <button
                    data-tab={tab.id}
                    class={`pb-2 px-1 text-sm uppercase tracking-wider transition-colors whitespace-nowrap ${tab.id === 'my-teams' ? 'border-b-2 border-blue-500 text-black dark:text-white font-bold' : 'text-neutral-500 hover:text-black dark:hover:text-white border-b-2 border-transparent'}`}
                >
                    {tab.label}
                </button>
            ))}
        </div>

        <!-- My Teams Panel -->
        <div data-panel="my-teams" class="space-y-12 animate-in fade-in duration-300">
            {/* Jump Links */}
            {teamData.length > 0 && (
                <div class="flex flex-wrap gap-3 text-sm">
                    <span class="text-neutral-500">Jump to:</span>
                    {teamData.map(team => (
                        <a
                            href={`#${team.name.toLowerCase().replace(/\s+/g, '-')}`}
                            class="text-blue-600 dark:text-blue-400 hover:underline"
                        >
                            {team.name}
                        </a>
                    ))}
                </div>
            )}

            {teamData.length === 0 && !fetchError && <p class="text-neutral-500 italic">No recent news found for your teams.</p>}

            {teamData.map(team => (
                <div id={team.name.toLowerCase().replace(/\s+/g, '-')} class="space-y-4 scroll-mt-4">
                    <h2 class="text-xl font-bold text-black dark:text-white border-b border-neutral-200 dark:border-neutral-800 pb-2">
                        {team.name} <span class="text-sm font-normal text-neutral-500 ml-2">{team.league}</span>
                    </h2>
                    <ul class="space-y-4">
                        {team.items.map((item) => (
                            <li>
                                <a href={item.link} target="_blank" rel="noopener noreferrer" class="block w-fit group">
                                    <h3 class="text-sm font-medium text-neutral-900 dark:text-neutral-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                        {decodeHtmlEntities(item.title)}
                                    </h3>
                                </a>
                                <div class="mt-1 flex items-center gap-3 text-xs text-neutral-500 font-mono">
                                    <span>{formatRelativeTime(item.date)}</span>
                                    <span class="text-neutral-300 dark:text-neutral-700">•</span>
                                    <span class="text-neutral-400">{getSourceDomain(item.link)}</span>
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            ))}
        </div>

        <!-- All News Panel -->
        <div data-panel="all" class="space-y-8 hidden animate-in fade-in duration-300">
             <ul class="space-y-6">
                {allLeagueNews && allLeagueNews.map((item) => (
                    <li>
                        <a href={item.link} target="_blank" rel="noopener noreferrer" class="block w-fit group">
                            <div class="flex items-baseline justify-between gap-4">
                                <h3 class="text-base font-medium text-neutral-900 dark:text-neutral-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                    {decodeHtmlEntities(item.title)}
                                </h3>
                                <span class="shrink-0 text-[10px] font-mono uppercase tracking-wider text-neutral-400 bg-neutral-100 dark:bg-neutral-800 px-2 py-1 rounded">
                                    {item.league} • {item.source}
                                </span>
                            </div>
                        </a>
                        <div class="mt-1 flex items-center gap-3 text-xs text-neutral-500 font-mono">
                            <span>{formatRelativeTime(item.date)}</span>
                        </div>
                    </li>
                ))}
            </ul>
        </div>

        <!-- MLB Panel -->
        <div data-panel="mlb" class="space-y-8 hidden animate-in fade-in duration-300">
             <ul class="space-y-6">
                {allLeagueNews && allLeagueNews.filter(i => i.league === 'MLB').map((item) => (
                    <li>
                        <a href={item.link} target="_blank" rel="noopener noreferrer" class="block w-fit group">
                            <div class="flex items-baseline justify-between gap-4">
                                <h3 class="text-base font-medium text-neutral-900 dark:text-neutral-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                    {decodeHtmlEntities(item.title)}
                                </h3>
                                <span class="shrink-0 text-[10px] font-mono uppercase tracking-wider text-neutral-400 bg-neutral-100 dark:bg-neutral-800 px-2 py-1 rounded">
                                    {item.source}
                                </span>
                            </div>
                        </a>
                        <div class="mt-1 flex items-center gap-3 text-xs text-neutral-500 font-mono">
                            <span>{formatRelativeTime(item.date)}</span>
                        </div>
                    </li>
                ))}
            </ul>
        </div>

        <!-- NBA Panel -->
        <div data-panel="nba" class="space-y-8 hidden animate-in fade-in duration-300">
             <ul class="space-y-6">
                {allLeagueNews && allLeagueNews.filter(i => i.league === 'NBA').map((item) => (
                    <li>
                        <a href={item.link} target="_blank" rel="noopener noreferrer" class="block w-fit group">
                            <div class="flex items-baseline justify-between gap-4">
                                <h3 class="text-base font-medium text-neutral-900 dark:text-neutral-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                    {decodeHtmlEntities(item.title)}
                                </h3>
                                <span class="shrink-0 text-[10px] font-mono uppercase tracking-wider text-neutral-400 bg-neutral-100 dark:bg-neutral-800 px-2 py-1 rounded">
                                    {item.source}
                                </span>
                            </div>
                        </a>
                        <div class="mt-1 flex items-center gap-3 text-xs text-neutral-500 font-mono">
                            <span>{formatRelativeTime(item.date)}</span>
                        </div>
                    </li>
                ))}
            </ul>
        </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('[data-tab]');
    const panels = document.querySelectorAll('[data-panel]');

    // Handle Tabs
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = (tab as HTMLElement).dataset.tab;

        // Update tabs
        tabs.forEach(t => {
            if ((t as HTMLElement).dataset.tab === target) {
                t.classList.add('border-blue-500', 'text-black', 'dark:text-white', 'font-bold');
                t.classList.remove('text-neutral-500', 'border-transparent');
            } else {
                t.classList.remove('border-blue-500', 'text-black', 'dark:text-white', 'font-bold');
                t.classList.add('text-neutral-500', 'border-transparent');
            }
        });

        // Update panels
        panels.forEach(p => {
            if ((p as HTMLElement).dataset.panel === target) {
                p.classList.remove('hidden');
            } else {
                p.classList.add('hidden');
            }
        });
      });
    });

    // Handle Relative Time Update for Caching
    const updateLastUpdated = () => {
        const el = document.getElementById('last-updated');
        if (!el || !el.dataset.timestamp) return;

        const ts = new Date(el.dataset.timestamp);
        const now = new Date();
        const diff = Math.floor((now.getTime() - ts.getTime()) / 1000);

        let text = '';
        if (diff < 60) {
            text = 'Just now';
        } else if (diff < 3600) {
            text = `${Math.floor(diff / 60)}m ago`;
        } else if (diff < 86400) {
            text = `${Math.floor(diff / 3600)}h ago`;
        } else {
            text = ts.toLocaleDateString();
        }

        el.textContent = `Updated: ${text}`;
    };

    updateLastUpdated();
    // Update every minute
    setInterval(updateLastUpdated, 60000);
  });
</script>
