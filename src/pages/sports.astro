---
export const prerender = false;

import { getSportsPageData } from '../lib/sports-data';
import Layout from '../layouts/Layout.astro';
import TeamCard from '../components/sports/TeamCard.astro';

// Cache the response for 15 minutes (900 seconds) at the edge (Cloudflare) and in the browser.
// This prevents the Worker from running on every request, significantly reducing usage if scraped.
Astro.response.headers.set('Cache-Control', 'public, max-age=900, s-maxage=900');

const { teamData, allLeagueNews, fetchError } = await getSportsPageData();

const TEAM_LOGOS = {
    'Red Sox': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/mlb/500/bos.png&w=40&h=40',
    'Boston Red Sox': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/mlb/500/bos.png&w=40&h=40',
    'Knicks': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/nyk.png&w=40&h=40',
    'New York Knicks': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/nyk.png&w=40&h=40',
    'Celtics': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/bos.png&w=40&h=40',
    'Boston Celtics': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/bos.png&w=40&h=40',
    'Orioles': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/mlb/500/bal.png&w=40&h=40',
    'Baltimore Orioles': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/mlb/500/bal.png&w=40&h=40',
    'Pistons': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/det.png&w=40&h=40',
    'Detroit Pistons': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/det.png&w=40&h=40',
    'White Sox': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/mlb/500/chw.png&w=40&h=40',
    'Chicago White Sox': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/mlb/500/chw.png&w=40&h=40',
    'Spurs': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/sas.png&w=40&h=40',
    'San Antonio Spurs': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/sas.png&w=40&h=40',
    'Bulls': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/chi.png&w=40&h=40',
    'Chicago Bulls': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/chi.png&w=40&h=40',
    'Wizards': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/wsh.png&w=40&h=40',
    'Washington Wizards': 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/nba/500/wsh.png&w=40&h=40'
};

const LEAGUE_ICONS = {
    'MLB': '‚öæ',
    'NBA': 'üèÄ'
};

const now = new Date();
const lastUpdated = now.toLocaleString('en-US', {
    timeZone: 'America/New_York',
    dateStyle: 'medium',
    timeStyle: 'short'
});

const tabs = [
    { id: 'my-teams', label: 'My Teams' },
    { id: 'all', label: 'All News' },
    { id: 'mlb', label: '‚öæ MLB' },
    { id: 'nba', label: 'üèÄ NBA' }
];

function formatRelativeTime(dateInput) {
    if (!dateInput) return '';
    const date = new Date(dateInput);
    // Safety check for invalid dates
    if (isNaN(date.getTime())) return '';

    const now = new Date();
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
    const diffInDays = Math.floor(diffInSeconds / 86400);

    if (diffInDays === 0) {
        return 'Today';
    } else if (diffInDays === 1) {
        return 'Yesterday';
    } else {
        return `${diffInDays} days ago`;
    }
}

function decodeHtmlEntities(str) {
    if (!str) return "";
    return str.replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(dec))
              .replace(/&#x([0-9a-fA-F]+);/g, (match, hex) => String.fromCharCode(parseInt(hex, 16)))
              .replace(/&quot;/g, '"')
              .replace(/&apos;/g, "'")
              .replace(/&amp;/g, '&')
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>');
}

function getSourceDomain(url) {
    try {
        const domain = new URL(url).hostname;
        return domain.replace('www.', '');
    } catch (e) {
        return '';
    }
}
---

<Layout title="Sports Feed">
  <div class="max-w-2xl mx-auto px-4 py-8">
    <div class="flex justify-between items-end mb-8">
        <div>
            <h1 class="text-3xl font-bold text-black dark:text-white">Sports Feed</h1>
            <div class="text-xs text-neutral-400 mt-1 space-x-2">
                <span>Sources:</span>
                <a href="https://www.mlbtraderumors.com" target="_blank" rel="noopener noreferrer" class="hover:text-blue-500 transition-colors">MLB Trade Rumors</a>
                <a href="https://www.hoopsrumors.com" target="_blank" rel="noopener noreferrer" class="hover:text-blue-500 transition-colors">Hoops Rumors</a>
            </div>
        </div>
        <span id="last-updated" data-timestamp={now.toISOString()} class="text-xs text-neutral-500 font-mono mb-1">Updated: {lastUpdated}</span>
    </div>

    {fetchError && (
        <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm text-red-600 dark:text-red-400">
            <p class="font-bold">Unable to load some sports data.</p>
            <p>Please try refreshing the page in a few moments.</p>
        </div>
    )}

    <div class="space-y-6">
        <!-- Tabs Navigation -->
        <div class="flex gap-6 border-b border-neutral-200 dark:border-neutral-800 pb-1 overflow-x-auto">
            {tabs.map(tab => (
                <button
                    data-tab={tab.id}
                    class={`pb-2 px-1 text-sm uppercase tracking-wider transition-colors whitespace-nowrap ${tab.id === 'my-teams' ? 'border-b-2 border-blue-500 text-black dark:text-white font-bold' : 'text-neutral-500 hover:text-black dark:hover:text-white border-b-2 border-transparent'}`}
                >
                    {tab.label}
                </button>
            ))}
        </div>

        <!-- My Teams Panel -->
        <div data-panel="my-teams" class="space-y-12 animate-in fade-in duration-300">
            {/* Jump Links */}
            {teamData.length > 0 && (
                <div class="flex flex-wrap gap-4 items-center justify-between w-full">
                    {teamData.map(team => (
                        <a
                            href={`#${team.name.toLowerCase().replace(/\s+/g, '-')}`}
                            class="transition-transform hover:scale-110"
                            title={team.name}
                        >
                            {TEAM_LOGOS[team.name] ? (
                                <img src={TEAM_LOGOS[team.name]} class="w-8 h-8" alt={team.name} />
                            ) : (
                                <span class="text-2xl">{team.league === 'MLB' ? '‚öæ' : 'üèÄ'}</span>
                            )}
                        </a>
                    ))}
                </div>
            )}

            {teamData.length === 0 && !fetchError && <p class="text-neutral-500 italic">No recent news found for your teams.</p>}

            {teamData.map(team => (
                <TeamCard team={team} logoUrl={TEAM_LOGOS[team.name]} />
            ))}
        </div>

        <!-- All News Panel -->
        <div data-panel="all" class="space-y-8 hidden animate-in fade-in duration-300">
             <ul class="space-y-6">
                {allLeagueNews && allLeagueNews.map((item) => (
                    <li>
                        <a href={decodeHtmlEntities(item.link)} target="_blank" rel="noopener noreferrer" class="block w-full group no-underline">
                            <h3 class="text-sm font-medium text-neutral-900 dark:text-neutral-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                <span class="mr-2">{LEAGUE_ICONS[item.league] || 'üì∞'}</span>{decodeHtmlEntities(item.title)}
                            </h3>
                        </a>
                        <div class="mt-1 flex items-center gap-3 text-xs text-neutral-500 font-mono">
                            <span>{formatRelativeTime(item.date)}</span>
                            <span class="text-neutral-300 dark:text-neutral-700">‚Ä¢</span>
                            <span class="text-neutral-400">{item.league} ‚Ä¢ {item.source}</span>
                            <span class="text-neutral-300 dark:text-neutral-700">‚Ä¢</span>
                            <span class="text-neutral-400">{getSourceDomain(decodeHtmlEntities(item.link))}</span>
                        </div>
                    </li>
                ))}
            </ul>
        </div>

        <!-- MLB Panel -->
        <div data-panel="mlb" class="space-y-8 hidden animate-in fade-in duration-300">
             <ul class="space-y-6">
                {allLeagueNews && allLeagueNews.filter(i => i.league === 'MLB').map((item) => (
                    <li>
                        <a href={decodeHtmlEntities(item.link)} target="_blank" rel="noopener noreferrer" class="block w-full group no-underline">
                            <h3 class="text-sm font-medium text-neutral-900 dark:text-neutral-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                {decodeHtmlEntities(item.title)}
                            </h3>
                        </a>
                        <div class="mt-1 flex items-center gap-3 text-xs text-neutral-500 font-mono">
                            <span>{formatRelativeTime(item.date)}</span>
                            <span class="text-neutral-300 dark:text-neutral-700">‚Ä¢</span>
                            <span class="text-neutral-400">{item.source}</span>
                            <span class="text-neutral-300 dark:text-neutral-700">‚Ä¢</span>
                            <span class="text-neutral-400">{getSourceDomain(decodeHtmlEntities(item.link))}</span>
                        </div>
                    </li>
                ))}
            </ul>
        </div>

        <!-- NBA Panel -->
        <div data-panel="nba" class="space-y-8 hidden animate-in fade-in duration-300">
             <ul class="space-y-6">
                {allLeagueNews && allLeagueNews.filter(i => i.league === 'NBA').map((item) => (
                    <li>
                        <a href={decodeHtmlEntities(item.link)} target="_blank" rel="noopener noreferrer" class="block w-full group no-underline">
                            <h3 class="text-sm font-medium text-neutral-900 dark:text-neutral-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight">
                                {decodeHtmlEntities(item.title)}
                            </h3>
                        </a>
                        <div class="mt-1 flex items-center gap-3 text-xs text-neutral-500 font-mono">
                            <span>{formatRelativeTime(item.date)}</span>
                            <span class="text-neutral-300 dark:text-neutral-700">‚Ä¢</span>
                            <span class="text-neutral-400">{item.source}</span>
                            <span class="text-neutral-300 dark:text-neutral-700">‚Ä¢</span>
                            <span class="text-neutral-400">{getSourceDomain(decodeHtmlEntities(item.link))}</span>
                        </div>
                    </li>
                ))}
            </ul>
        </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('[data-tab]');
    const panels = document.querySelectorAll('[data-panel]');

    // Handle Tabs
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = (tab as HTMLElement).dataset.tab;

        // Update tabs
        tabs.forEach(t => {
            if ((t as HTMLElement).dataset.tab === target) {
                t.classList.add('border-blue-500', 'text-black', 'dark:text-white', 'font-bold');
                t.classList.remove('text-neutral-500', 'border-transparent');
            } else {
                t.classList.remove('border-blue-500', 'text-black', 'dark:text-white', 'font-bold');
                t.classList.add('text-neutral-500', 'border-transparent');
            }
        });

        // Update panels
        panels.forEach(p => {
            if ((p as HTMLElement).dataset.panel === target) {
                p.classList.remove('hidden');
            } else {
                p.classList.add('hidden');
            }
        });
      });
    });

    // Handle Relative Time Update for Caching
    const updateLastUpdated = () => {
        const el = document.getElementById('last-updated');
        if (!el || !el.dataset.timestamp) return;

        const ts = new Date(el.dataset.timestamp);
        const now = new Date();
        const diff = Math.floor((now.getTime() - ts.getTime()) / 1000);

        let text = '';
        if (diff < 60) {
            text = 'Just now';
        } else if (diff < 3600) {
            text = `${Math.floor(diff / 60)}m ago`;
        } else if (diff < 86400) {
            text = `${Math.floor(diff / 3600)}h ago`;
        } else {
            text = ts.toLocaleDateString();
        }

        el.textContent = `Updated: ${text}`;
    };

    updateLastUpdated();
    // Update every minute
    setInterval(updateLastUpdated, 60000);
  });
</script>
