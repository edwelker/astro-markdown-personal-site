---
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import { readingTime } from "@lib/utils";
import BackToPrevious from "@components/BackToPrevious.astro";
import PostNavigation from "@components/PostNavigation.astro";
import TableOfContents from "@components/TableOfContents.astro";
import Giscus from "@components/Giscus.astro";

type Post = CollectionEntry<"blog">;
type Props = { post: Post; prevPost?: Post; nextPost?: Post };

export async function getStaticPaths() {

  // 1. Fetch, filter, and sort all posts in one trusted operation.
  const allPosts = (await getCollection("blog"))
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  // 2. Generate the paths, injecting next/prev posts as props
  return allPosts.map((post, index) => {
    // Determine the next and previous post for navigation
    const prevPost = allPosts[index - 1] || undefined;
    const nextPost = allPosts[index + 1] || undefined;

    return {
      params: { id: post.slug },
      props: {
        post: post,
        prevPost: prevPost,
        nextPost: nextPost
      } as Props,
    };
  });
}

// Destructure all data from props, including injected navigation posts
const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);

// Your old helper functions (getNextPost and getPrevPost) are now deleted
// because the navigation data is passed directly via props.
---

<Layout title={post.data.title} description={post.data.description ?? ''}>
  <Container>
    <main class="prose dark:prose-invert mx-auto py-8">

      <h1 class="text-3xl font-bold">{post.data.title}</h1>
        <p class="text-sm text-gray-500">
            Published: <FormattedDate date={post.data.date} />
            &bull; Read time: {readingTime(post.body ?? "")} min
        </p>

      <TableOfContents headings={headings} />

      <Content />

      <PostNavigation prevPost={prevPost} nextPost={nextPost} />

      <BackToPrevious href="/blog" />

      <Giscus />

    </main>
  </Container>
</Layout>
