---
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import { readingTime } from "@lib/utils";
import BackToPrevious from "@components/BackToPrevious.astro";
import PostNavigation from "@components/PostNavigation.astro";
import TableOfContents from "@components/TableOfContents.astro";
import Giscus from "@components/Giscus.astro";

type Post = CollectionEntry<"blog">;
type Props = { post: Post; prevPost?: Post; nextPost?: Post };

export async function getStaticPaths() {
  const allPosts = (await getCollection("blog"))
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  return allPosts.map((post, index) => {
    const prevPost = allPosts[index - 1] || undefined;
    const nextPost = allPosts[index + 1] || undefined;

    // --- LOGIC: Check if slug already has a date structure ---
    let customPath = post.slug;

    // If the slug DOES NOT start with 4 digits and a slash (e.g. "2025/"), add the date.
    if (!post.slug.match(/^\d{4}\//)) {
        const date = new Date(post.data.date);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        customPath = `${year}/${month}/${day}/${post.slug}`;
    }
    // -------------------------------------------------------

    return {
      params: { id: customPath },
      props: {
        post,
        prevPost,
        nextPost
      } as Props,
    };
  });
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);
---

<Layout title={post.data.title} description={post.data.description ?? ''}>
  <Container>
    <main class="prose dark:prose-invert mx-auto py-8">

        <h1 class="text-3xl font-bold">{post.data.title}</h1>

        {post.data.featuredImage && (
            <figure class="my-6">
                <img
                    src={post.data.featuredImage}
                    alt={post.data.featuredImageAlt || `Featured image for ${post.data.title}`}
                    loading="lazy"
                    class="w-full h-auto rounded-lg shadow-lg"
                />
            </figure>
        )}

        <p class="text-sm text-gray-500">
            Published: <FormattedDate date={post.data.date} />
            &bull; Read time: {readingTime(post.body ?? "")} min
        </p>

      <TableOfContents headings={headings} />

      <Content />

      <PostNavigation
        prevPost={prevPost}
        nextPost={nextPost}
      />

      <BackToPrevious href="/blog" />

      <Giscus />

    </main>
  </Container>
</Layout>
