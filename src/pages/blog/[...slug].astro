---
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import { readingTime } from "@lib/utils";
import BackToPrevious from "@components/BackToPrevious.astro";
import PostNavigation from "@components/PostNavigation.astro";
import TableOfContents from "@components/TableOfContents.astro";
import Giscus from "@components/Giscus.astro";
import BlogSchema from "@components/BlogSchema.astro";
import { getPostHref } from "@lib/blog";
import BlogFeaturedImage from "@components/BlogFeaturedImage.astro";

type Post = CollectionEntry<"blog">;
type Props = { post: Post; prevPost?: Post; nextPost?: Post };

export async function getStaticPaths() {
  const allPosts = (await getCollection("blog"))
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  return allPosts.map((post, index) => {
    // Note: in a descending sort, index - 1 is actually the NEWER post
    // and index + 1 is the OLDER post.
    const nextPost = allPosts[index - 1] || undefined;
    const prevPost = allPosts[index + 1] || undefined;
    
    return { params: { slug: post.slug }, props: { post, prevPost, nextPost } as Props };
  });
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);

// Safely generate description from body if not provided in frontmatter
const seoDescription = post.data.description || 
  (post.body ? post.body.replace(/[#*`\[\]]/g, '').trim().slice(0, 155) + '...' : '');

// Resolve navigation HREFs using the shared utility
const prevHref = prevPost ? getPostHref(prevPost) : undefined;
const nextHref = nextPost ? getPostHref(nextPost) : undefined;

// Debug log to check if coverImage is being retrieved
if (post.data.coverImage) {
  console.log(`[Blog] Rendering coverImage for ${post.data.title}:`, post.data.coverImage);
}
---

<Layout title={post.data.title} description={seoDescription}>
  <BlogSchema post={post} slot="head" />
  <Container>
    <main class="prose dark:prose-invert mx-auto py-8">
      <h1 class="text-3xl font-bold">{post.data.title}</h1>
      <div class="flex items-center gap-2 text-sm text-neutral-600 dark:text-neutral-400 mb-8">
        <FormattedDate date={post.data.date} />
        <span>&bull;</span>
        <span>{readingTime(post.body ?? "")} min read</span>
      </div>
      {post.data.coverImage && (
        <BlogFeaturedImage 
          coverImage={post.data.coverImage} 
          alt={post.data.coverImageAlt}
          title={post.data.title}
        />
      )}
      <TableOfContents headings={headings} />
      <Content />
      <div class="mt-24">
        <PostNavigation 
          prevPost={prevPost ? { ...prevPost, href: prevHref } : undefined} 
          nextPost={nextPost ? { ...nextPost, href: nextHref } : undefined} 
        />
      </div>
      <div class="mt-8"><BackToPrevious href="/blog/">Back to blog</BackToPrevious></div>
      <div class="mt-24"><Giscus /></div>
    </main>
  </Container>
</Layout>
