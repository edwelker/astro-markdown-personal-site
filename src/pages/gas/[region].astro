---
import Layout from "@layouts/Layout.astro";
import gasData from "@data/gas.json";

export function getStaticPaths() {
  return [
    { params: { region: "md" }, props: { name: "Maryland", data: gasData.md } },
    { params: { region: "ny" }, props: { name: "New York", data: gasData.ny } },
    { params: { region: "ma" }, props: { name: "Massachusetts", data: gasData.ma } },
  ];
}

const { region } = Astro.params;
const { name, data: rawData } = Astro.props;

const title = `Gas Prices - ${name}`;
const description = `Latest gas prices for ${name}.`;

function formatPrice(price: string | number) {
  if (price === undefined || price === null || price === '') return '';
  const num = parseFloat(String(price).replace(/[^0-9.-]+/g, ""));
  return isNaN(num) ? String(price) : num.toFixed(2);
}

// Normalize keys and Ensure Net price exists and Sort
const data = rawData.map((row: any) => {
  // Helper to get value case-insensitively
  const getVal = (key: string) => {
    if (row[key] !== undefined) return row[key];
    const lowerKey = key.toLowerCase();
    const foundKey = Object.keys(row).find(k => k.toLowerCase() === lowerKey);
    return foundKey ? row[foundKey] : undefined;
  };

  let net = getVal('Net');
  const baseRaw = getVal('Base');
  const discountRaw = getVal('Discount');

  // Check if net is missing or empty string
  if (net === undefined || net === null || String(net).trim() === '') {
    const baseStr = String(baseRaw || "").replace(/[^0-9.-]+/g, "");
    const discountStr = String(discountRaw || "0").replace(/[^0-9.-]+/g, "");
    
    const base = parseFloat(baseStr);
    const discount = parseFloat(discountStr);
    
    if (!isNaN(base)) {
      // Default discount to 0 if NaN
      const finalDiscount = isNaN(discount) ? 0 : discount;
      net = (base - finalDiscount).toFixed(2);
    } else {
      // If base is invalid, keep net as is (likely empty or undefined)
      net = baseRaw; 
    }
  }
  
  return {
    Station: getVal('Station'),
    Address: getVal('Address'),
    City: getVal('City'),
    Zip: getVal('Zip'),
    Base: baseRaw,
    Discount: discountRaw,
    Net: net
  };
}).sort((a: any, b: any) => {
  const netA = parseFloat(String(a.Net).replace(/[^0-9.-]+/g, ""));
  const netB = parseFloat(String(b.Net).replace(/[^0-9.-]+/g, ""));
  
  // Handle NaNs by pushing them to the end
  if (isNaN(netA) && isNaN(netB)) return 0;
  if (isNaN(netA)) return 1;
  if (isNaN(netB)) return -1;
  
  return netA - netB;
});
---

<Layout title={title} description={description}>
  <div class="w-full px-2 sm:px-4 py-8">
    <div class="animate" data-pagefind-body>
      <div class="mb-6 max-w-screen-md mx-auto">
        <a href="/gas" class="text-sm text-neutral-500 hover:text-black dark:hover:text-white transition-colors">← Back to Gas</a>
        <h1 class="font-semibold text-2xl mt-2">{name} Gas Prices</h1>
      </div>

      <div class="mb-4 max-w-screen-md mx-auto">
        <input
          type="text"
          id="gas-filter"
          placeholder="Filter by City or Zip..."
          class="w-full px-4 py-2 border border-neutral-200 dark:border-neutral-700 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-neutral-500"
        />
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full text-xs sm:text-sm text-left whitespace-nowrap">
          <thead class="text-neutral-500 uppercase bg-neutral-50 dark:bg-neutral-800 dark:text-neutral-400">
            <tr>
              <th class="px-2 py-3 select-none">Station</th>
              <th class="px-2 py-3 select-none">Address</th>
              <th class="px-2 py-3 cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="City" data-label="City">City ↕</th>
              <th class="px-2 py-3 cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="Zip" data-label="Zip">Zip ↕</th>
              <th class="px-2 py-3 text-right cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="Base" data-label="Price">Price ↕</th>
              <th class="px-2 py-3 text-right select-none">Discount</th>
              <th class="px-2 py-3 text-right cursor-pointer hover:text-black dark:hover:text-white select-none" data-sort="Net" data-label="Net">Net ↑</th>
            </tr>
          </thead>
          <tbody id="gas-table-body">
            {data.map((row) => (
              <tr class="border-b border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-800/50">
                <td class="px-2 py-3 font-medium">{row.Station}</td>
                <td class="px-2 py-3">
                  <a 
                    href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${row.Address}, ${row.City} ${row.Zip}`)}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:underline"
                  >
                    {row.Address}
                  </a>
                </td>
                <td class="px-2 py-3">{row.City}</td>
                <td class="px-2 py-3">{row.Zip}</td>
                <td class="px-2 py-3 text-right">{formatPrice(row.Base)}</td>
                <td class="px-2 py-3 text-right">{formatPrice(row.Discount)}</td>
                <td class="px-2 py-3 text-right font-bold">{formatPrice(row.Net)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <p class="text-xs text-neutral-400 mt-4 text-center">
        Data sourced from <a href="https://github.com/edwelker/find_cheap_local_gas" class="underline">edwelker/find_cheap_local_gas</a>.
      </p>
    </div>
  </div>
</Layout>

<script define:vars={{ initialData: data }}>
  let sortCol = 'Net';
  let sortAsc = true;
  let filterQuery = "";

  const tableBody = document.getElementById('gas-table-body');
  const filterInput = document.getElementById('gas-filter');
  const headers = document.querySelectorAll('th[data-sort]');

  function formatPrice(val) {
    if (val === undefined || val === null || val === '') return '';
    const num = parseFloat(String(val).replace(/[^0-9.-]+/g, ""));
    return isNaN(num) ? String(val) : num.toFixed(2);
  }

  function renderTable(data) {
    tableBody.innerHTML = data.map(row => `
      <tr class="border-b border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-800/50">
        <td class="px-2 py-3 font-medium">${row.Station || ''}</td>
        <td class="px-2 py-3">
          <a 
            href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((row.Address || '') + ', ' + (row.City || '') + ' ' + (row.Zip || ''))}"
            target="_blank"
            rel="noopener noreferrer"
            class="hover:underline"
          >
            ${row.Address || ''}
          </a>
        </td>
        <td class="px-2 py-3">${row.City || ''}</td>
        <td class="px-2 py-3">${row.Zip || ''}</td>
        <td class="px-2 py-3 text-right">${formatPrice(row.Base)}</td>
        <td class="px-2 py-3 text-right">${formatPrice(row.Discount)}</td>
        <td class="px-2 py-3 text-right font-bold">${formatPrice(row.Net)}</td>
      </tr>
    `).join('');
  }

  function parseCurrency(val) {
    if (typeof val !== 'string') return val;
    return parseFloat(val.replace(/[^0-9.-]+/g,""));
  }

  function updateTable() {
    // Filter
    let filtered = initialData.filter(row => {
      const cityMatch = row.City && row.City.toLowerCase().includes(filterQuery);
      const zipMatch = row.Zip && row.Zip.toString().includes(filterQuery);
      return cityMatch || zipMatch;
    });

    // Sort
    if (sortCol) {
      filtered.sort((a, b) => {
        let valA = a[sortCol];
        let valB = b[sortCol];

        if (['Base', 'Net', 'Discount'].includes(sortCol)) {
          valA = parseCurrency(valA);
          valB = parseCurrency(valB);
          
          // Handle NaNs in sort
          if (isNaN(valA) && isNaN(valB)) return 0;
          if (isNaN(valA)) return 1;
          if (isNaN(valB)) return -1;
        } else {
          if (typeof valA === 'string') valA = valA.toLowerCase();
          if (typeof valB === 'string') valB = valB.toLowerCase();
        }

        if (valA < valB) return sortAsc ? -1 : 1;
        if (valA > valB) return sortAsc ? 1 : -1;
        return 0;
      });
    }
    
    // Update Headers
    headers.forEach(th => {
      const col = th.getAttribute('data-sort');
      const label = th.getAttribute('data-label');
      let arrow = ' ↕';
      if (col === sortCol) {
        arrow = sortAsc ? ' ↑' : ' ↓';
      }
      th.textContent = label + arrow;
    });

    renderTable(filtered);
  }

  headers.forEach(th => {
    th.addEventListener('click', () => {
      const column = th.getAttribute('data-sort');
      if (sortCol === column) {
        sortAsc = !sortAsc;
      } else {
        sortCol = column;
        sortAsc = true;
      }
      updateTable();
    });
  });

  filterInput.addEventListener('input', (e) => {
    filterQuery = e.target.value.toLowerCase();
    updateTable();
  });
</script>
